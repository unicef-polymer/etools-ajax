<link rel="import" href="../../polymer/polymer.html">
<!--<link rel="import" href="../etools-ajax.html">-->

<dom-module id="multipart-demo-data">

  <script>
    (function() {
      // jscs:disable
      'use strict';

      Polymer({
        is: 'multipart-demo-data',
        properties: {
          bodyPost: {
            type: Object,
            value: null,
            notify: true
          },
          customBody: {
            type: Object,
            value: null,
            notify: true
          }
        },

        ready: function() {
          this._processImgFile('big-image.jpg'); // image of more than 8Mb placed inside demo folder

          var partnerData = {
            id: 54,
            staffMembers: [
              {
                id: 1,
                name: 'Adrian Hangan',
                email: 'adrian.hangan@test.test'
              },
              {
                id: 2,
                name: 'Robert Avram',
                email: 'robert.avram@test.test'
              },
            ],
            assessments: [
              {
                id: 1,
                signed_date: '2017-02-17',
                assessmentFile: function () {
                  var content = '<a id="assessment_1"><b>First assessment content</b></a>';
                  return new Blob([content], { type: "text/xml"});
                }()
              },
              {
                id: 2,
                signed_date: '2017-02-17',
                assessmentFile: function () {
                  var content = '<a id="assessment_2"><b>Second assessment content</b></a>';
                  return new Blob([content], { type: "text/xml"});
                }()
              }
            ],
            attachements: [],
            vendorId: null
          }

          var body = new FormData();
          Object.keys(partnerData).forEach(function(key) {
            var data = partnerData[key];
            if (key !== 'assessments') {
              body.append(key, JSON.stringify(data));
            } else {
              // setup assessments
              if (data.length) {
                data.forEach(function(assessment, index) {
                  Object.keys(assessment).forEach(function(assessKey) {
                    body.append(key + '[' + index + '][' + assessKey + ']', assessment[assessKey]);
                  });
                }); 
              } else {
                body.append(key, []);
              }
            }
          });

          this.set('customBody', body);

          console.log('======= Parse backend data example ========', this._prepareData());
        },

        _processImgFile: function (imageURL) {
          var _self = this;
          var image = new Image();
          var onload = function () {
            var canvas = document.createElement("canvas");
            canvas.width =this.width;
            canvas.height =this.height;

            var ctx = canvas.getContext("2d");
            ctx.drawImage(this, 0, 0);

            canvas.toBlob(function(blob) {
              // do stuff with blob
              console.log(blob);
              _self.set('bodyPost', {
                id: "13",
                firstName: "John",
                lastName: "Doe",
                testObj: {
                  id: 1,
                  name: 'testing'
                },
                testArr: [
                  {
                    id: 2,
                    name: 'testing 2',
                    someArray: [1,3],
                    hahah: {
                      test: [1,2,3, function () {
                          var content = '<a id="id1"><b id="b">hey you 1!</b></a>';
                          return new Blob([content], { type: "text/xml"});
                        }()],
                      ahaaaaaaaa: {
                        id: 1,
                        id_2: [
                          { 
                            file: function () {
                            var content = '<a id="id2"><b id="b">hey you 2!</b></a>';
                            return new Blob([content], { type: "text/xml"});
                            }()
                          }
                        ],
                        objectHahaha: {
                          partner: 1,
                          agreement: 2,
                          assessment: function () {
                            var content = '<a id="id3"><b id="b">hey you 3!</b></a>';
                            return new Blob([content], { type: "text/xml"});
                            }()
                        }
                      }
                    }
                  },
                  1,2,3,4,5,
                  function () {
                    var content = '<a id="someId"><b id="b">hey you!</b></a>';
                    return new Blob([content], { type: "text/xml"});
                  }(),
                ],
                testArr2: [],
                someFile: function () {
                  var content = '<a id="a"><b id="b">hey!</b></a>';
                  return new Blob([content], { type: "text/xml"});
                }(),
                bigImage: blob
              });
            });
          };

          image.onload = onload;
          image.src = imageURL;
        },

        _prepareData: function() {
          var result = { 
            id: JSON.parse('54'),
            staffMembers: JSON.parse('[{"id":1,"name":"Adrian Hangan","email":"adrian.hangan@test.test"},{"id":2,"name":"Robert Avram","email":"robert.avram@test.test"}]'),  
            assessments: [],
            attachements: JSON.parse('[]'),
            vendorId: JSON.parse('null')
          };
          var assessments = {
            'assessments[0][type]': 'some string | file',
            'assessments[0][signed_date]': 'some string | file',
            'assessments[0][file]': 'some file',
            'assessments[1][type]': 'some string | file',
            'assessments[1][signed_date]': 'some string | file',
            'assessments[1][file]': 'some file'
          };
          Object.keys(assessments).forEach(function(key) {
            var prop = key.substring(0, key.length - 1).replace('][', ' ');
            prop = prop.replace(']', '');
            prop = prop.replace('assessments[', '');
            prop = prop.split(' ');
            console.log(prop);
            if (!result.assessments[prop[0]]) {
              result.assessments[prop[0]] = {};
            }
            result.assessments[prop[0]][prop[1]] = assessments[key];
          });
         
          return result;
        }

      });

    })();
  </script>
</dom-module>
