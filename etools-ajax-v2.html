<link rel="import" href="es6-obj-assign-polyfil.html">
<link rel="import" href="../etools-dexiejs/dexiejs.html">
<link rel="import" href="axios.html">


<link rel="import" href="../iron-ajax/iron-request.html">


<script>
  (function(window, axios) {
    'use strict';

    function defineEtoolsAjax() {
      var etoolsAjax = {

        config: {
          timeout: 60000
        },

        showLogs: false,

        useCSRF: false,
        csrf: {
          xsrfHeaderName: 'x-csrftoken',
          xsrfCookieName: 'csrftoken'
        },

        cacheDb: null,

        _log: function(type, message, method, url, params, forceDisplay, aditionalData) {
          var logMsg = '[etools-ajax] ';
          if (this.showLogs || forceDisplay) {
            if (message) {
              logMsg += message;
            }
            if (method && url) {
              logMsg += method + ' ' + url + ' , params: ' + JSON.stringify(params);
            }
            if (type === 'error') {
              console.error(logMsg);
            } else {
              console.log(logMsg);
            }
          }
          if (type === 'warn') {
            console.warn(logMsg + ' ' + message, aditionalData);
          }
        },

        setConfigDefaults: function(config, csrf) {
          // set global configs
          if (config && typeof config === 'object') {
            if (typeof config.useCSRF !== 'undefined') {
              this.useCSRF = config.useCSRF;
              delete config.useCSRF;
            }
            if (typeof config.showLogs !== 'undefined') {
              this.showLogs = config.showLogs;
              delete config.showLogs;
            }
            if (typeof config.cacheDb instanceof Dexie) {
              this.cacheDb = config.cacheDb;
              delete config.cacheDb;
            }

            this.config = this._prepareConfig(config);
          }
          // config/activate csrf
          if (csrf && typeof csrf === 'object' && csrf.headerName && csrf.cookieName) {
            this.csrf = Object.assign({}, csrf);
            this.useCSRF = true;
          }
        },

        _prepareConfig: function(config) {
          return Object.assign({}, this.config, config);
        },

        _getResponseType: function(config) {
          config = config ? config : this.config;
          if (config && config.responseType) {
            return config.responseType;
          }
          if (axios.defaults.responseType) {
            return axios.defaults.responseType;
          }
          return 'json'; // default
        },

        _validateEndpointObject: function(endpoint) {
          if (typeof endpoint === 'object' && typeof endpoint.url === 'string' && endpoint.url !== '') {
            return true;
          }
          return false;
        },

        _getEndpointUrl: function(endpoint) {
          var url = null;
          if (!this._validateEndpointObject(endpoint)) {
            if (typeof endpoint === 'string' && endpoint !== '') {
              url = endpoint;
            }
          } else {
            url = endpoint.url;
          }
          return url;
        },

        _getEndpointCacheKey: function(endpoint, params) {
          var cacheKey = endpoint.url;
          if (typeof endpoint.cachingKey === 'string' && endpoint.cachingKey !== '') {
            cacheKey = endpoint.cachingKey;
          }
          if (params) {
            cacheKey += '_' + JSON.stringify(params);
          }
          return cacheKey;
        },

        get: function(endpoint, config) {
          // get URL
          var url = this._getEndpointUrl(endpoint);
          if (!url) {
            // no url, do not continue
            return;
          }
          // check for cached data
          if (typeof endpoint === 'object' && typeof endpoint.exp === 'number' && endpoint.exp > 0) {

          }

          config = this._prepareConfig(config);
          var _this = this;
          return new Promise(function(resolve, reject) {
            axios.get(url, config).then(function (response) {
              if (_this._getResponseType(config) === 'json' && typeof response.data === 'string') {
                response.data = JSON.parse(response.data);
              }
              resolve(response.data);
            })
            .catch(function (error) {
              reject(error.response);
            });
          });
        },

        post: function(url, data) {
          console.log('fire post request');
        },
        patch: function(url, data) {
          console.log('fire path request');
        },
        delete: function(url, data) {
          console.log('fire delete request');
        }

      };
      return etoolsAjax;
    }
 
    // make EtoolsAjax global if not already
    window.EtoolsAjax = window.EtoolsAjax || defineEtoolsAjax();

    function defineEtoolsRequest() {
      var etoolsRequest = {
        properties: {
          reqProgress: {
            type: Object,
            notify: true,
            readOnly: true,
            value: function() {
              return null;
            }
          },
          checkReqProgress: {
            type: Object,
            value: function() {
              return null;
            }
          }
        },
        observers: [
          '_checkRequestProgress(progress)'
        ],
        sendRequest: function(reqConfig) {
          var request = /** @type {!IronRequestElement} */ (document.createElement('iron-request'));
          var reqConfigOptions = this._prepareConfigOptions(reqConfig);

          this._checkRequestProgress(request, reqConfig.checkProgress);

          return new Promise(function(resolve, reject) {
            request.completes.then(function(request) {
              var responseData = request.response;
              if (reqConfigOptions.handleAs === 'json' && typeof responseData === 'string') {
                responseData = JSON.parse(responseData);
              }
              resolve(responseData);
            }).catch(function(request, error) {
              var errorDetails = {
                error: error,
                status: request.xhr.status,
                statusText: request.xhr.statusText,
                response: request.xhr.response
              };
              reject(errorDetails);
            }.bind(this, request));
            request.send(reqConfigOptions);
          });
        },

        _prepareConfigOptions: function(reqConfig) {
          return {
            url: reqConfig.url || '',
            method: reqConfig.method || 'GET',
            headers: this._getRequestHeaders('application/json', reqConfig.body, reqConfig.headers),
            body: reqConfig.body || {},
            async: !reqConfig.sync,
            handleAs: reqConfig.handleAs || 'json',
            jsonPrefix: reqConfig.jsonPrefix || '',
            withCredentials: !!reqConfig.withCredentials,
            timeout: reqConfig.timeout || 0
          };
        },
       
        _getRequestHeaders: function(cType, body, aditionalHeaders) {
          var headers = {};
          var contentType = cType;
          if (contentType == null && (typeof body === 'string')) {
            contentType = 'application/x-www-form-urlencoded';
          }
          if (contentType) {
            headers['content-type'] = contentType;
          }
          var header;
          if (aditionalHeaders instanceof Object) {
            for (header in aditionalHeaders) {
              headers[header] = aditionalHeaders[header].toString();
            }
          }
          return headers;
        },

        _checkRequestProgress: function(request, checkProgress) {
          if (!checkProgress || !request || !request.progress) {
            return;
          }
          this.checkReqProgress = setInterval(function() {
            if (request.progress.constructor === Object && Object.keys(request.progress).length > 0) {
              this._setReqProgress(request.progress);
              if (!request.progress.lengthComputable || request.progress.loaded === request.progress.total) {
                this._stopReqProgressCheck();
              }
            }
          }.bind(this), 0);
        },
        _stopReqProgressCheck: function() {
          if (this.checkReqProgress) {
            clearInterval(this.checkReqProgress);
          }
        }

      };

      return etoolsRequest;
    }

    window.EtoolsRequest = window.EtoolsRequest || defineEtoolsRequest();


  })(window, axios);
</script>
