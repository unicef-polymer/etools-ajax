<link rel="import" href="es6-obj-assign-polyfil.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="etools-ajax-logs-behavior.html">
<link rel="import" href="etools-ajax-data-behavior.html">
<link rel="import" href="etools-ajax-cache-behavior.html">
<link rel="import" href="etools-endpoints-behavior.html">

<script>
  (function(window) {
    'use strict';

    function EtoolsRequestError(errorDetails) {
      this.error = errorDetails.error,
      this.status = errorDetails.status,
      this.statusText = errorDetails.statusText,
      this.response = errorDetails.response
    }

    function defineEtoolsRequest() {
      var etoolsRequest = {
        properties: {
          reqProgress: {
            type: Object,
            notify: true,
            readOnly: true,
            value: function() {
              return null;
            }
          },
          checkReqProgress: {
            type: Object,
            value: function() {
              return null;
            },

            // ironRequestOptions: {
            //   type:Object,
            //   value: function() {
            //     return {
            //         url: '',
            //         method:'GET',
            //         headers: '',
            //         body: '',
            //         async: true,
            //         handleAs: 'json',
            //         jsonPrefix: '',
            //         withCredentials: false,
            //         timeout: 0
            //     }
            //   }
            // },
          }
        },

        sendRequest: function(reqConfig) {
          // prepare request config options
          var preparedConfigOptions =  this._prepareConfigOptions(reqConfig);
          var reqConfigOptions = preparedConfigOptions.ironRequestOptions;
          var cachingInfo = preparedConfigOptions.cachingInfo;
          console.log(reqConfigOptions, cachingInfo);
//          if (!reqConfigOptions.url || reqConfigOptions.url === '') {
//            this.etoolsAjaxLog('warn', 'the url can not be empty string!', null, null, null, true);
//            return;
//          }

//          var cachedResponse = this._tryGetCachedData(cachingInfo);
//          if(cachedResponse) {
//             return new Promise(function(resolve) {
//               resolve(cachedResponse);
//               });
//          }

          var request = /** @type {!IronRequestElement} */ (document.createElement('iron-request'));
          this._checkRequestProgress(request, reqConfig.checkProgress);

          var self = this;

            request.send(reqConfigOptions);
            return request.completes.then(function(request) {
              self.etoolsAjaxLog('log', 'have response', null, null, null, true);
              var responseData = request.response;

              if (reqConfigOptions.handleAs === 'json' && typeof responseData === 'string') {
                responseData = JSON.parse(responseData);
              }

              if(cachingInfo && cachingInfo.requestIsViableForCaching &&
                self.cachingCanBeMade(cachingInfo.cacheTableName)) {
                // add/cache response data into dexie db
                return self.cacheEndpointData(responseData, cachingInfo);
              }
              return responseData;
            }).catch(function(request, error) {
              // request failed
              var errorDetails = {
                error: error,
                status: request.xhr.status,
                statusText: request.xhr.statusText,
                response: request.xhr.response
              };
              //reject(errorDetails);
              throw new EtoolsRequestError(errorDetails);
            }.bind(this, request));
        },

        _tryGetCachedData: function(cachingInfo) {
           if (cachingInfo && cachingInfo.requestIsViableForCaching) {
              return this.getEndpointDataFromCache(cachingInfo);
           }
           return null;
        },

        _prepareConfigOptions: function(reqConfig) {
          return {
                  ironRequestOptions : {
                      url: this._getRequestUrl(reqConfig),
                      method: reqConfig.method || 'GET',
                      headers: this._getRequestHeaders(reqConfig),
                      body: this._getRequestBody(reqConfig),
                      async: !reqConfig.sync,
                      handleAs: this._getHandleAs(reqConfig),
                      jsonPrefix: reqConfig.jsonPrefix || '',
                      withCredentials: !!reqConfig.withCredentials,
                      timeout: reqConfig.timeout || 0
                   },
                   cachingInfo : this.getCachingInfo(reqConfig)
                 };
        },

        _getHandleAs: function(reqConfig) {
          var handleAs =  reqConfig.handleAs || 'json';
          if(reqConfig.downloadCsv)
            handleAs = 'blob';
          return handleAs;
        },

        _getRequestUrl: function(reqConfig){
          var url = '';
          if(reqConfig.endpoint && reqConfig.endpoint.url) {
             url = reqConfig.endpoint.url;
             url += this._buildQueryString(url, reqConfig.params);
          }
          return url;
        },

        _buildQueryString: function(url, params) {
           var queryStr ='';
           if (!params || !this._isNonEmptyObject(params)) {
             return '';
           }
           if (url.indexOf("?") < 0) {
              queryStr = '?';
            } else {
              queryStr = '&';
            }
           for (var key in params) {
             queryStr += key + '=' + params[key] +'&';
           };

           queryStr = queryStr.substring(0, queryStr.length - 1);//remove trailing &

           return queryStr;
        },

        _getRequestBody: function(reqConfig) {
          var body = reqConfig.body || {};
          if (reqConfig.multiPart) {
            body = this._prepareMultiPartFormData(body, reqConfig.prepareMultipartData);
          }
          return body;
        },

        _getRequestHeaders: function(reqConfig) {
          var headers = {};

          headers['content-type'] = this._determineContentType(reqConfig.body);

          if (reqConfig.downloadCsv) {
            headers['Accept'] ='text/csv';
            headers['Content-Type'] = 'text';
          }

          var clientConfiguredHeaders = this._getClientConfiguredHeaders(reqConfig.headers);
          var csrfHeaders = {};
          if (!this._csrfSafeMethod(reqConfig.method)) {
            csrfHeaders = this._getCsrfHeader(reqConfig.csrfCheck)
          }
          headers = Object.assign({}, headers, clientConfiguredHeaders, csrfHeaders);
          return headers;
        },

        _getClientConfiguredHeaders: function(aditionalHeaders) {
          var header;
          var clientHeaders = {};
          if (aditionalHeaders && aditionalHeaders instanceof Object) {
            for (header in aditionalHeaders) {
              clientHeaders[header] = aditionalHeaders[header].toString();
            }
          }
          return clientHeaders;
        },

        _getCsrfHeader: function(csrfCheck) {
          var csrfHeaders = {};
          if (csrfCheck !== 'disabled') {
            var csrfToken = this._getCSRFCookie();

            if (csrfToken) {
              csrfHeaders['x-csrftoken'] = csrfToken;
              this._log('log', 'CSRF ' + this.csrfCheck + ', token: ' + csrfToken + ' ', this.method, this.url, this.body);
            }
          }
          return csrfHeaders;
        },

        _csrfSafeMethod: function (method) {
          // these HTTP methods do not require CSRF protection
          return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        },

        _getCSRFCookie: function () {
          // check for a csrftoken cookie and return its value
          var csrfCookieName = 'csrftoken';
          var csrfToken = null;
          if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
              var cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, csrfCookieName.length + 1) === (csrfCookieName + '=')) {
                csrfToken = decodeURIComponent(cookie.substring(csrfCookieName.length + 1));
                break;
              }
            }
          }
          return csrfToken;
        },

         //* Content-Type set here can be overriden later
         // by headers sent from the client
        _determineContentType: function(body) {
          var contentType = 'application/json';

          if(typeof body === 'string') {
             contentType = 'application/x-www-form-urlencoded';
          }

          return contentType;
        },

        _checkRequestProgress: function(request, checkProgress) {
          if (!checkProgress || !request || !request.progress) {
            return;
          }
          this.checkReqProgress = setInterval(function() {
            if (request.progress.constructor === Object && Object.keys(request.progress).length > 0) {
              this._setReqProgress(request.progress);
              if (!request.progress.lengthComputable || request.progress.loaded === request.progress.total) {
                this._stopReqProgressCheck();
              }
            }
          }.bind(this), 0);
        },
        _stopReqProgressCheck: function() {
          if (this.checkReqProgress) {
            clearInterval(this.checkReqProgress);
          }
        }
      };

      return etoolsRequest;
    }

    window.EtoolsRequest = window.EtoolsRequest ||
      [EtoolsAjaxLogsBehavior, EtoolsAjaxDataBehavior, EtoolsEndpointsBehavior,
        EtoolsAjaxCacheBehavior, defineEtoolsRequest()];
  })(window);
</script>
