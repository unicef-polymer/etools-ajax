<link rel="import" href="es6-obj-assign-polyfil.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="etools-ajax-logs-behavior.html">
<link rel="import" href="etools-ajax-data-behavior.html">
<link rel="import" href="etools-ajax-cache-behavior.html">
<link rel="import" href="etools-endpoints-behavior.html">

<script>
  (function(window) {
    'use strict';

    function defineEtoolsRequest() {
      var etoolsRequest = {
        properties: {
          reqProgress: {
            type: Object,
            notify: true,
            readOnly: true,
            value: function() {
              return null;
            }
          },
          checkReqProgress: {
            type: Object,
            value: function() {
              return null;
            }
          }
        },

        sendRequest: function(reqConfig) {
          var request = /** @type {!IronRequestElement} */ (document.createElement('iron-request'));
          var reqConfigOptions = this._prepareConfigOptions(reqConfig);

          this._checkRequestProgress(request, reqConfig.checkProgress);
          var _this = this;
          return new Promise(function(resolve, reject) {
            request.completes.then(function(request) {
              _this.etoolsAjaxLog('log', 'have response', null, null, null, true);
              var responseData = request.response;
              if (reqConfigOptions.handleAs === 'json' && typeof responseData === 'string') {
                responseData = JSON.parse(responseData);
              }
              resolve(responseData);
            }).catch(function(request, error) {
              var errorDetails = {
                error: error,
                status: request.xhr.status,
                statusText: request.xhr.statusText,
                response: request.xhr.response
              };
              reject(errorDetails);
            }.bind(this, request));
            request.send(reqConfigOptions);
          });
        },

        _prepareConfigOptions: function(reqConfig) {
          return {
            url: reqConfig.url || '',
            method: reqConfig.method || 'GET',
            headers: this._getRequestHeaders('application/json', reqConfig.body, reqConfig.headers),
            body: reqConfig.body || {},
            async: !reqConfig.sync,
            handleAs: reqConfig.handleAs || 'json',
            jsonPrefix: reqConfig.jsonPrefix || '',
            withCredentials: !!reqConfig.withCredentials,
            timeout: reqConfig.timeout || 0
          };
        },
       
        _getRequestHeaders: function(cType, body, aditionalHeaders) {
          var headers = {};
          var contentType = cType;
          if (contentType == null && (typeof body === 'string')) {
            contentType = 'application/x-www-form-urlencoded';
          }
          if (contentType) {
            headers['content-type'] = contentType;
          }
          var header;
          if (aditionalHeaders instanceof Object) {
            for (header in aditionalHeaders) {
              headers[header] = aditionalHeaders[header].toString();
            }
          }
          return headers;
        },

        _checkRequestProgress: function(request, checkProgress) {
          if (!checkProgress || !request || !request.progress) {
            return;
          }
          this.checkReqProgress = setInterval(function() {
            if (request.progress.constructor === Object && Object.keys(request.progress).length > 0) {
              this._setReqProgress(request.progress);
              if (!request.progress.lengthComputable || request.progress.loaded === request.progress.total) {
                this._stopReqProgressCheck();
              }
            }
          }.bind(this), 0);
        },
        _stopReqProgressCheck: function() {
          if (this.checkReqProgress) {
            clearInterval(this.checkReqProgress);
          }
        }
      };

      return etoolsRequest;
    }

    window.EtoolsRequest = window.EtoolsRequest ||
      [EtoolsAjaxLogsBehavior, EtoolsAjaxDataBehavior, EtoolsEndpointsBehavior,
        EtoolsAjaxCacheBehavior, defineEtoolsRequest()];
  })(window);
</script>
