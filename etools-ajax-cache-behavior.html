<script>
  (function(window) {
    'use strict';

    function defineEtoolsAjaxCacheBehavior() {
      var etoolsAjaxCacheBehavior = {

        properties: {
          etoolsAjaxCacheDb: {
            type: Object,
            value: null
          },
          etoolsAjaxCacheDefaultTableName: {
            type: String,
            value: 'ajaxDefaultDataTable'
          },
          etoolsAjaxCacheListsExpireMapTable: {
            type: String,
            value: 'listsExpireMapTable'
          }
        },

        /**
         * Get caching info for the current request
         */
        getCachingInfo: function(reqConfig) {
          if (this._requestIsViableForCaching(reqConfig)) {
            return {
              requestIsViableForCaching : true,
              url: reqConfig.endpoint.url,
              exp: parseInt(reqConfig.endpoint.exp, 10), // ensure this value is integer
              cacheKey: this._getEndpointCacheKey(reqConfig.endpoint, reqConfig.params),
              cacheTableName: reqConfig.endpoint.cacheTableName || this.etoolsAjaxCacheDefaultTableName
            };
          }

          return null;
        },

        /**
         * etoolsAjaxCacheDb should be instance of Dexie
         * cacheTableName and listsExpireMapTable tables should be defined
         */
        cachingCanBeMade: function(cacheTableName) {
          return this.etoolsAjaxCacheDb instanceof Dexie &&
            this.etoolsAjaxCacheDb[this.etoolsAjaxCacheListsExpireMapTable] &&
            this.etoolsAjaxCacheDb[cacheTableName];
        },

        /**
         * Cache data into dexie db default table (etoolsAjaxCacheDefaultTableName)
         */
        _cacheEndpointDataUsingDefaultTable: function(dataToCache) {
          var self = this;
          return this.etoolsAjaxCacheDb[this.etoolsAjaxCacheDefaultTableName].put(dataToCache)
            .then(function(result) {
              // data added in dexie db in default table, return existing data
              console.log('data cached into default table... yey');
              return dataToCache.data;
            }).catch(function(error) {
              // something happened and inserting data in dexie table failed;
              // just log the error and return the existing data(received from server)
              self.etoolsAjaxLog('warn', 'Failed to add data in etools-ajax dexie db. Data not cached.',
                null, null, null, false, error);
              return dataToCache.data;
            });
        },

        /**
         * Cache date into specified dexie db table (reqConfig.endpoint.cacheTableName)
         */
        _cacheEndpointDataUsingSpecifiedTable: function(responseData, cachingInfo) {
          var listsExpireMapTable = this.etoolsAjaxCacheDb[this.etoolsAjaxCacheListsExpireMapTable];
          var specifiedTable = this.etoolsAjaxCacheDb[cachingInfo.cacheTableName];
          var self = this;
          return this.etoolsAjaxCacheDb.transaction('rw', listsExpireMapTable, specifiedTable, function() {
            if (responseData instanceof Array === false) {
              throw new Error('Response data should be array or objects to be ' +
                'able to cache it into specified table.');
            }
            // make all add actions using transaction
            // specifiedTable name and expire time for it must be added into listsExpireMapTable
            var listExpireDetails = {
              name: cachingInfo.cacheTableName,
              expire: cachingInfo.exp + Date.now()
            };
            // add list expire mapping details
            listsExpireMapTable.put(listExpireDetails);
            // save bulk data
            specifiedTable.bulkPut(responseData);
          }).then(function(result) {
            // request response saved into specified table
            // transaction succeeded
            console.log('transaction succedded...');
            return responseData;
          }).catch(function(error) {
            // transaction failed
            // just log the error and return the existing data(received from server)
            self.etoolsAjaxLog('warn', 'Failed to add data in etools-ajax dexie specified table: ' +
              cachingInfo.cacheTableName + '. Data not cached.',
              null, null, null, false, error);
            return responseData;
          });
        },

        /**
         * Cache endpoint received data
         */
        cacheEndpointData: function(responseData, cachingInfo) {
          if (cachingInfo.cacheTableName === this.etoolsAjaxCacheDefaultTableName) {
            var dataToCache = {
              cacheKey: cachingInfo.cacheKey,
              data: responseData,
              expire: cachingInfo.exp + Date.now()
            };
            // cache data into default dexie table
            // single object added into default dexie db table
            console.log('data cached into default table started');
            return this._cacheEndpointDataUsingDefaultTable(dataToCache);
          } else {
            // cache data into specified dexie table, array of objects bulk added into a specified table
            console.log('data cached into specified table started');
            return this._cacheEndpointDataUsingSpecifiedTable(responseData, cachingInfo);
          }
        },

        getEndpointDataFromCache: function(cachingInfo) {
           var cacheKey = cachingInfo.cacheKey;

            if (this._storageIsDexie() && !this._storageIsCustomDexieDb()) { // data is cached in default dexie database
              return this._getDexieData(cachingInfo);
            } else if (this._storageIsCustomDexieDb()) {   // data is cached in a custom database (user's choice)
              return this._getDexieDataFromCustomDb(cachingInfo);
            } else {
              // data is cached in localstorage
              var cachedData = JSON.parse(window.localStorage.getItem(cacheKey) || null);
              this._logCachedDataStatus(cachedData, cachingInfo);
              return cachedData;
            }
        },

        _getDexieData: function(cachingInfo) {
          var cacheKey = cachingInfo.cacheKey;

           if (!this.ajaxCacheDb) {
             this.getDexieCacheKey = cacheKey;
             return null;
           }

          this.ajaxCacheDb.ajaxCachedData.where('cacheKey').equals(cacheKey).toArray()
            .then(function(result) {
            if (result && result.length > 0 && !this._cacheDataIsExpired(result[0])) {
               var cachedData = {
                  detail: result[0].data,
                  exp: result[0].expire
                }
              }

              this._logCachedDataStatus(cachedData, cachingInfo)

              return cachedData;

            }.bind(this))
            .catch(function(err) {
                this._logCachedDataError(err, cachingInfo)
            }.bind(this));

            return null;
        },

        _logCachedDataError: function(err, cachingInfo) {
            this._log('warn', 'Failed to get data from etools-ajax dexie db.', null, null, null, false, err);
            this._logFireNewRequest(cachingInfo.url);
        },
        _logCachedDataStatus: function(cachedData, cachingInfo) {
            if(cachedData)
            {
              if (this.logs)
                  this._logSuccesfulCacheDataRetrieval(cachingInfo);
            }
            else {
              this._logFireNewRequest(cachingInfo.url);
            }
        },

        _logFireNewRequest: function(url) {
            this._log('log', 'Fire new request to get data from ' +  cachingInfo.url);
        },

        _cacheDataIsExpired: function(cachedData) {
           var now = Date.now();
           return (cachedData.exp - now) < 0;
        },

        _getDexieDataFromCustomDb: function(cachingInfo) {
          this.alternateDexieDb.collectionsList.where('name').equals(this.dexieDbCollection).toArray().then(function(result) {
            if (result && result.length > 0 && !this._cacheDataIsExpired(result[0])) {
              // collection already exists, get it's data
              this.alternateDexieDb[this.dexieDbCollection].toArray().then(function(collectionData) {
                var cachedData = {
                  detail: collectionData,
                  exp: result[0].expire
                }
                this._logCachedDataStatus(cachedData, cachingInfo);
                return cachedData;
              }.bind(this)).catch(function(err) {
                this._logCachedDataError(err, cachingInfo)
              }.bind(this));
            } else {
              this._logFireNewRequest(cachingInfo.url);
            }
          }.bind(this));
          return null;
        },

       _logSuccesfulCacheDataRetrieval: function(cachingInfo) {
            var logMsg = 'Return data from caching storage (';
            if (this._storageIsCustomDexieDb()) {
              logMsg += 'custom DexieDb, collection: ' + this.dexieDbCollection;
            } else {
              logMsg += (this.cachingStorage === 'custom' ? 'localstorage' : this.cachingStorage)
              + ', key: ' + (cachingInfo.cacheKey);
            }
            logMsg += ') for ';
            this._log('log', logMsg, "GET", cachingInfo.url, cachingInfo.params);
        },

        _storageIsDexie: function() {
          return this.cachingStorage === 'dexie';
        },

        _storageIsCustomDexieDb: function() {
          if (this.alternateDexieDb instanceof Dexie && this.dexieDbCollection !== ""
           && this.alternateDexieDb[this.dexieDbCollection]) {
             if (this.alternateDexieDb.collectionsList) {
               return true;
            } else {
               this._log('error', 'Invalid dexie version store for provided db. Missing "collectionsList : \"&name,expire\""');
            }
          }
          return false;
        },

        _requestIsViableForCaching: function(reqConfig) {
          return (reqConfig.method || 'GET') === 'GET' &&  this._expireTimeWasProvided(reqConfig.endpoint)
        },

        _expireTimeWasProvided: function(endpoint) {
          return endpoint && endpoint.hasOwnProperty('exp') && endpoint.exp > 0;
        },

        _getEndpointCacheKey: function(endpoint, params) {
          var cacheKey = endpoint.url;
          if (this._isNonEmptyString(endpoint.cachingKey)) {
              cacheKey = endpoint.cachingKey;
          }
          if (this._isNonEmptyObject(this.params)) {
             cacheKey += '_' + JSON.stringify(params);
          }
          return cacheKey;
        },

        _isNonEmptyString: function(input) {
          return (input && typeof input === 'string');
        },

        _isNonEmptyObject: function(input) {
          return input && typeof input === 'object' && Object.keys(input).length > 0
        }

      };

      return etoolsAjaxCacheBehavior;
    }

    window.EtoolsAjaxCacheBehavior = window.EtoolsAjaxCacheBehavior || defineEtoolsAjaxCacheBehavior();
  })(window);
</script>
