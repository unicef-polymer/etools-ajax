<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<!--<link rel="import" href="../../behaviors/common/utils.html">-->
<!--
`etools-ajax`

Polymer element for handling ajax requests.

### Usage

You can chose to use directly the URL to make the request, no caching will be made in this case.
Also you can use an endpoint object that contains url, exp (expire date in milliseconds) and cachingKey properties.
CachingKey property is optional and it's recommended if you use lokiJS as local database for caching.
If is not set then the url will be the caching key. If exp property is not set then no caching will be made for this endpoint.

```
var endpoint = {
  url: 'your/api/route',
  exp: 1473931993881,
  cachingKey: 'dataSetIdentifierString'
);
```

If any of the url or endpoint properties changes, the ajax requests automatically fires. In endpoint case, before triggering
the new request we search to see if we already have this data in local cache storage. If data is found and did not expired
automatically fire/return response with found data. If data for the new endpoint is not found or is expired then make the request.




@demo demo/index.html 
-->

<dom-module id="etools-ajax">
  <template>
    <iron-ajax
        auto
        id="customAjax"
        on-response="handleResponse"
        on-error="handleError"
        handle-as="[[handleAs]]"
        method="[[method]]"
        params="[[params]]"
        debounce-duration="300"
        loading="{{loading}}">
    </iron-ajax>
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'etools-ajax',
        properties: {
          authToken: {
            type: String,
            value: ''
          },
          handleAs: {
            type: String,
            value: 'json'
          },
          loading: {
            type: Boolean,
            value: false,
            notify: true
          },
          method: {
            type: String,
            method: 'GET'
          },
          params: {
            type: Object,
            value: null
          },
          body: {
            type: Object,
            value: null
          },
          url: {
            type: String,
            value: null,
            observer: '_prepareRequest'
          },
          endpoint: {
            type: Object,
            observer: '_endpointChanged'
          },
          cachingStorage: {
            type: String,
            value: 'localstorage' // or loki
          }
        },
        _startLoading: function () {
          this.loading = true;
        },
        _stopLoading: function () {
          this.loading = false;
        },
        _csrfSafeMethod: function (method) {
          // these HTTP methods do not require CSRF protection
          return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        },
        _getCSRFCookie: function () {
          // check for a csrftoken cookie and return its value
          var csrfCookieName = 'csrftoken';
          var csrfToken = null;
          if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
              var cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, csrfCookieName.length + 1) === (csrfCookieName + '=')) {
                csrfToken = decodeURIComponent(cookie.substring(csrfCookieName.length + 1));
                break;
              }
            }
          }
          return csrfToken;
        },
        _prepareRequest: function (newUrl) {
          // if the url is provided we have to prepare the request
          if ((this.method !== undefined) && (!this._csrfSafeMethod(this.method))) {
            // unsafe (post, put, delete) requests should be triggered manually

            // TODO: trigger post/put/delete requests here

            return;
          }
          // assign new url to ajax element , this will automatically fire the request
          this.$.customAjax.url = newUrl;

          if (newUrl !== null) {
            this._startLoading();
          }
        },
        _getEndpointCacheKey: function(endpoint) {
          var cacheKey = endpoint.url;
          if (typeof endpoint.cachingKey === 'string' && endpoint.cachingKey !== '') {
            cacheKey = endpoint.cachingKey;
          }
          return cacheKey;
        },
        _validateEndpointObject: function(endpoint) {
          if (endpoint.hasOwnProperty('url') && endpoint.url !== '') {
            return true;
          }
          console.error('Endpoint object must have url property set')
          return false;
        },
        _endpointChanged: function (newEndpoint) {
          if (!this._validateEndpointObject(newEndpoint)) {
            return;
          }
          // Check if endpoint has expire property set
          if (newEndpoint.exp) {
            // check if we have cached data
            var now = Date.now();
            // determine request cache key
            var cacheKey = this._getEndpointCacheKey(newEndpoint);
            //  Try to get info from cache storage
            if (this.cachingStorage === 'loki') {
              // data is cached in loki database

              // TODO: implement loki caching


            } else {
              // data is cached in localstorage
              var rsp = JSON.parse(window.localStorage.getItem(cacheKey) || null);
            }

            if ((rsp) && ((rsp.exp - now) > 0)) {
              // else fire response where rsp.detail is the info from localstorage/loki
              this.fire('response', rsp.detail);
            } else {
              // If expired shoot a new request
              this.url = newEndpoint.url;
            }
          } else {
            // no caching set, fire a new request
            this.url = newEndpoint.url;
          }
        },
        handleError: function (event, error) {
          this._stopLoading();
          console.log('handling the error from etools-ajax');
          console.log('add error checking and validation here');
          // TODO: alert with needed errors.
          console.error([error.error, 'while loading', event.srcElement.url].join(': '));
          // in case the user is logged out...
          if ([401, 403].indexOf(error.request.status) !== -1) {
            window.location = this.getEp('login');
            return;
          }
          app.$.alert.showText('Page has not loaded sucessfully ' + event.srcElement.url);
          this.fire('error', {
            request: event,
            error: error.error
          }, {bubbles: false});
        },

        handleResponse: function (response) {
          // TODO: check if endpoint should be in localstorage
          // TODO: if true place response in localstorage + expiration time (expiration time should be taken based on each endpoint)
          console.log(response.detail.xhr.response);
//          return false;
          // set local storage
          if (this.ep && this.ep.exp) {
            var localVal = {
              detail: response.detail.xhr.response,
              exp: this.ep.exp + Date.now(),
            };

//            window.localStorage.setItem(this.ep.url, JSON.stringify(localVal));
          }

          // set response object
          var data = response.detail.xhr.response;

          if (this.handleAs === 'json' && (typeof data === 'string')) {
            data = JSON.parse(data);
          }

          this.fire('response', data);
          this._stopLoading();
        },

        sendPostRequest: function () {
          console.log('unsafe method', this.method);
          var csrfToken = this._getCSRFCookie();
          this.$.customAjax.auto = false;
          this.$.customAjax.body = this.body;
          this.$.customAjax.contentType = 'application/json';
          this.$.customAjax.headers = {
            'X-CSRFToken': csrfToken
          };
          this.$.customAjax.url = this.url;
          this.$.customAjax.generateRequest();
          this._startLoading();
          return;
        },



      });
    })();
  </script>
</dom-module>
