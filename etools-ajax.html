<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/debounce.html">
<link rel="import" href="etools-ajax-request-mixin.html">

<dom-module id="etools-ajax">

  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @appliesMixin EtoolsAjaxRequestMixin
     */
    class EtoolsAjax extends EtoolsAjaxRequestMixin(Polymer.Element) {
      static get is() {
        return 'etools-ajax';
      }

      static get properties() {
        return {
          url: String,
          method: String,
          endpoint: Object,
          params: Object,
          body: Object
        };
      }

      static get observers() {
        return [
          '_optionsChanged(url)',
          '_optionsChanged(endpoint)',
          '_optionsChanged(params)',
          '_optionsChanged(method)'
        ];
      }

      send() {
        let opt = {
          endpoint: this.endpoint || {url: this.url},
          params: this.params,
          method: this.method,
          body: this.body
        };

        return this.sendRequest(opt)
            .then((data) => {
              this.dispatchEvent(new CustomEvent('success', {detail: data, bubbles: true, composed: true}));
              return data;
            })
            .catch((error) => {
              this.handleError(error);
            });
      }

      _optionsChanged() {
        this._debouncer = Polymer.Debouncer.debounce(this._debouncer,
            Polymer.Async.timeOut.after(300),
            () => {
              if (!this.endpoint && !this.url) {
                return;
              }
              this.send();
            });
      }

      handleError(error) {
        if (error.status === 401) {
          this.dispatchEvent(new CustomEvent('unauthorized', {detail: error.error, bubbles: true, composed: true}));
          return;
        }

        if (error.status === 403) {
          this.dispatchEvent(new CustomEvent('forbidden', {detail: error.error, bubbles: true, composed: true}));
          return;
        }
        this.logError('error', error.error);
        this.dispatchEvent(new CustomEvent('fail', {detail: error.error, bubbles: true, composed: true}));
      }
    }

    customElements.define(EtoolsAjax.is, EtoolsAjax);
  </script>
</dom-module>
